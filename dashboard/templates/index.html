<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proxy Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #f4f4f9; color: #333; }
        header { background-color: #2c3e50; color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.5rem; }
        .container { padding: 2rem; max-width: 1400px; margin: 0 auto; }

        /* Summary Cards */
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
        .card h3 { margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #7f8c8d; text-transform: uppercase; letter-spacing: 1px; }
        .card .value { font-size: 2rem; font-weight: bold; color: #2c3e50; }
        .card .unit { font-size: 0.9rem; color: #95a5a6; }

        /* Charts Grid */
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 1.5rem; }
        .chart-container { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .chart-container h2 { margin-top: 0; font-size: 1.1rem; color: #34495e; border-bottom: 1px solid #ecf0f1; padding-bottom: 0.5rem; margin-bottom: 1rem; }

        canvas { width: 100% !important; height: 300px !important; }

        @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header>
        <h1>Proxy Analytics</h1>
        <div style="font-size: 0.9rem;">Live updates every 2s</div>
    </header>

    <div class="container">
        <!-- Summary Stats -->
        <div class="summary-grid">
            <div class="card">
                <h3>Total Requests</h3>
                <div class="value" id="totalRequests">{{ stats.total_requests }}</div>
            </div>
            <div class="card">
                <h3>Blocked Requests</h3>
                <div class="value" id="blockedRequests">{{ stats.blocked_requests }}</div>
            </div>
            <div class="card">
                <h3>Avg Latency</h3>
                <div class="value"><span id="avgLatency">{{ stats.avg_latency }}</span><span class="unit">ms</span></div>
            </div>
            <div class="card">
                <h3>Total Bandwidth</h3>
                <div class="value"><span id="totalBandwidth">{{ stats.total_bandwidth }}</span><span class="unit">MB</span></div>
            </div>
            <div class="card">
                <h3>Unique Clients</h3>
                <div class="value" id="uniqueClients">{{ stats.unique_clients }}</div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-container">
                <h2>Requests per Minute</h2>
                <canvas id="requestsChart"></canvas>
            </div>

            <div class="chart-container">
                <h2>Avg Latency per Minute</h2>
                <canvas id="latencyChart"></canvas>
            </div>

            <div class="chart-container">
                <h2>Top Requested Domains</h2>
                <canvas id="domainsChart"></canvas>
            </div>

            <div class="chart-container">
                <h2>Bandwidth per Domain (Top 5)</h2>
                <canvas id="bandwidthChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Chart defaults
        Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
        Chart.defaults.color = '#7f8c8d';

        // Initial data from Flask
        const initialStats = {{ stats | tojson | safe }};
        const socket = io();

        const charts = {
            requests: null,
            latency: null,
            domains: null,
            bandwidth: null
        };

        function hasData(labels, data) {
            return Array.isArray(labels) && Array.isArray(data) && labels.length > 0 && data.length > 0;
        }

        function setNoDataState(canvasId, show) {
            const canvas = document.getElementById(canvasId);
            if (!canvas || !canvas.parentElement) return;

            const container = canvas.parentElement;
            let marker = container.querySelector('[data-empty-for="' + canvasId + '"]');

            if (show) {
                canvas.style.display = 'none';
                if (!marker) {
                    marker = document.createElement('div');
                    marker.setAttribute('data-empty-for', canvasId);
                    marker.textContent = 'No data available yet';
                    marker.style.textAlign = 'center';
                    marker.style.color = '#95a5a6';
                    marker.style.padding = '2rem 0';
                    container.appendChild(marker);
                }
            } else {
                canvas.style.display = 'block';
                if (marker) {
                    marker.remove();
                }
            }
        }

        function updateSummaryCards(data) {
            document.getElementById('totalRequests').textContent = data.total_requests ?? 0;
            document.getElementById('blockedRequests').textContent = data.blocked_requests ?? 0;
            document.getElementById('avgLatency').textContent = data.avg_latency ?? 0;
            document.getElementById('totalBandwidth').textContent = data.total_bandwidth ?? 0;
            document.getElementById('uniqueClients').textContent = data.unique_clients ?? 0;
        }

        function upsertLineChart(chartKey, canvasId, labels, values, label, color) {
            const ready = hasData(labels, values);
            setNoDataState(canvasId, !ready);
            if (!ready) {
                return;
            }

            if (!charts[chartKey]) {
                charts[chartKey] = new Chart(document.getElementById(canvasId), {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label,
                            data: values,
                            borderColor: color,
                            backgroundColor: color.replace(')', ', 0.1)').replace('rgb', 'rgba'),
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
                return;
            }

            charts[chartKey].data.labels = labels;
            charts[chartKey].data.datasets[0].data = values;
            charts[chartKey].update();
        }

        function upsertDomainsChart(labels, values) {
            const ready = hasData(labels, values);
            setNoDataState('domainsChart', !ready);
            if (!ready) return;

            if (!charts.domains) {
                charts.domains = new Chart(document.getElementById('domainsChart'), {
                    type: 'doughnut',
                    data: {
                        labels,
                        datasets: [{
                            data: values,
                            backgroundColor: ['#2ecc71', '#3498db', '#9b59b6', '#f1c40f', '#e67e22'],
                            borderWidth: 0
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
                return;
            }

            charts.domains.data.labels = labels;
            charts.domains.data.datasets[0].data = values;
            charts.domains.update();
        }

        function upsertBandwidthChart(labels, values) {
            const ready = hasData(labels, values);
            setNoDataState('bandwidthChart', !ready);
            if (!ready) return;

            if (!charts.bandwidth) {
                charts.bandwidth = new Chart(document.getElementById('bandwidthChart'), {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Bandwidth (MB)',
                            data: values,
                            backgroundColor: '#1abc9c',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true } }
                    }
                });
                return;
            }

            charts.bandwidth.data.labels = labels;
            charts.bandwidth.data.datasets[0].data = values;
            charts.bandwidth.update();
        }

        function renderMetrics(data) {
            updateSummaryCards(data);
            upsertLineChart(
                'requests',
                'requestsChart',
                data.requests_time_labels || [],
                data.requests_time_data || [],
                'Requests',
                'rgb(52, 152, 219)'
            );
            upsertLineChart(
                'latency',
                'latencyChart',
                data.requests_time_labels || [],
                data.latency_time_data || [],
                'Latency (ms)',
                'rgb(231, 76, 60)'
            );
            upsertDomainsChart(data.top_domains_labels || [], data.top_domains_data || []);
            upsertBandwidthChart(data.bw_domains_labels || [], data.bw_domains_data || []);
        }

        // Render initial server-side state.
        renderMetrics(initialStats);

        // Live updates from Flask-SocketIO.
        socket.on('metrics_update', function (data) {
            renderMetrics(data || {});
        });
    </script>
</body>
</html>
